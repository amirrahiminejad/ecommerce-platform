<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${ad.title} + ' - Iran ECommerce'">Ad Details - Iran ECommerce</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Universal Styles -->
    <link href="/css/universal-styles.css" rel="stylesheet">
    <link href="/css/ads-view-compact-styles.css" rel="stylesheet">
</head>
<body>
    <!-- Compact Navigation -->
    <nav class="navbar navbar-expand-lg compact-nav">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/images/logo-persia-bazaar-small.png" alt="Iran ECommerce" height="28">
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="bi bi-house"></i>
                </a>
                <a class="nav-link" href="/ads">
                    <i class="bi bi-grid-3x3-gap"></i>
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid compact-container">
        <!-- Compact Breadcrumb -->
        <nav aria-label="breadcrumb" class="compact-breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item" th:if="${ad.category}">
                    <span th:text="${ad.category.name}">Category</span>
                </li>
                <li class="breadcrumb-item active" th:text="${ad.title}">Ad Title</li>
            </ol>
        </nav>


        <div class="row g-3">
            <!-- Left Column - Images -->
            <div class="col-lg-6">
                <div class="image-gallery-container">
                    <!-- Main Image Display -->
                    <div class="main-image-container">
                        <div th:if="${ad.images != null and #lists.size(ad.images) > 0}" 
                             class="main-image-wrapper">
                            <img id="mainImage" 
                                 th:src="@{'/uploads/' + ${ad.images[0].image.filename}}" 
                                 class="main-image" 
                                 th:alt="${ad.title}"
                                 onclick="openImageModal(this.src)">
                            <div class="image-overlay">
                                <button class="btn btn-zoom" onclick="openImageModal(document.getElementById('mainImage').src)">
                                    <i class="bi bi-zoom-in"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div th:unless="${ad.images != null and #lists.size(ad.images) > 0}" 
                             class="no-image-compact">
                            <i class="bi bi-image"></i>
                            <span>No Image Available</span>
                        </div>
                    </div>
                    
                    <!-- Thumbnail Slider -->
                    <div th:if="${ad.images != null and #lists.size(ad.images) > 1}" 
                         class="thumbnail-slider">
                        <div class="thumbnail-track" id="thumbnailTrack">
                            <div th:each="adImage, iterStat : ${ad.images}" 
                                 class="thumbnail-item"
                                 th:onclick="'changeMainImage(\'' + @{'/uploads/' + ${adImage.image.filename}} + '\', ' + ${iterStat.index} + ')'">
                                <img th:src="@{'/uploads/' + ${adImage.image.filename}}" 
                                     th:alt="${ad.title}"
                                     th:class="${iterStat.index == 0} ? 'thumbnail-image active' : 'thumbnail-image'">
                            </div>
                        </div>
                        
                        <!-- Thumbnail Navigation -->
                        <button class="thumbnail-nav prev" onclick="scrollThumbnails('prev')" 
                                th:style="${#lists.size(ad.images) <= 4} ? 'display: none;' : ''">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="thumbnail-nav next" onclick="scrollThumbnails('next')"
                                th:style="${#lists.size(ad.images) <= 4} ? 'display: none;' : ''">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column - Details -->
            <div class="col-lg-6">
                <div class="ad-details-compact">
                    <!-- Header Section -->
                    <div class="ad-header">
                        <div class="price-section">
                            <span class="price-amount" th:text="${#numbers.formatDecimal(ad.price, 0, 'COMMA', 0, 'POINT')} + ' $'">
                                Price
                            </span>
                            <span class="status-badge" th:class="'status-' + ${#strings.toLowerCase(ad.status)}" 
                                  th:text="${ad.status}">Status</span>
                        </div>
                        <h1 class="ad-title" th:text="${ad.title}">Ad Title</h1>
                        <div class="ad-meta">
                            <span class="location">
                                <i class="bi bi-geo-alt"></i>
                                <span th:text="${ad.location != null ? ad.location.city : 'Unknown Location'}">Location</span>
                            </span>
                            <span class="date">
                                <i class="bi bi-clock"></i>
                                <span th:text="${#temporals.format(ad.createdAt, 'dd MMM yyyy')}">Date</span>
                            </span>
                            <span class="views">
                                <i class="bi bi-eye"></i>
                                <span th:text="${ad.viewsCount} + ' views'">Views</span>
                            </span>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="description-section">
                        <h3>Description</h3>
                        <p class="description-text" th:text="${ad.description}">
                            Ad description goes here...
                        </p>
                    </div>

                    <!-- Quick Info Grid -->
                    <div class="quick-info-grid">
                        <div class="info-item" th:if="${ad.category}">
                            <span class="info-label">Category</span>
                            <span class="info-value" th:text="${ad.category.name}">Category</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Negotiable</span>
                            <span class="info-value" th:text="${ad.negotiable ? 'Yes' : 'No'}">Negotiable</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Posted</span>
                            <span class="info-value" th:text="${#temporals.format(ad.createdAt, 'dd/MM/yyyy')}">Date</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Views</span>
                            <span class="info-value" th:text="${ad.viewsCount}">Views</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seller Info Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="seller-card-compact">
                    <div class="seller-info">
                        <div class="seller-avatar" th:text="${#strings.substring(ad.user.firstName, 0, 1) + #strings.substring(ad.user.lastName, 0, 1)}">
                            UN
                        </div>
                        <div class="seller-details">
                            <h4 class="seller-name" th:text="${ad.user.firstName + ' ' + ad.user.lastName}">Seller Name</h4>
                            <p class="seller-join" th:text="'Member since ' + ${#temporals.format(ad.user.createdAt, 'MMMM yyyy')}">
                                Member since
                            </p>
                        </div>
                    </div>

                    <!-- Contact Methods -->
                    <div class="contact-methods">
                        <!-- Phone -->
                        <button th:if="${ad.user.phoneNumber}" 
                                class="contact-btn phone-btn" 
                                onclick="showPhoneCompact(this)"
                                th:data-phone="${ad.user.phoneNumber}">
                            <i class="bi bi-telephone"></i>
                            <span>Call</span>
                        </button>

                        <!-- Message -->
                        <button class="contact-btn message-btn" data-bs-toggle="modal" data-bs-target="#contactModal">
                            <i class="bi bi-chat-dots"></i>
                            <span>Message</span>
                        </button>

                        <!-- Email -->
                        <button th:if="${ad.user.email}" 
                                class="contact-btn email-btn" 
                                onclick="sendEmail(this)"
                                th:data-email="${ad.user.email}">
                            <i class="bi bi-envelope"></i>
                            <span>Email</span>
                        </button>

                        <!-- WhatsApp -->
                        <a th:if="${ad.user.whatsapp != null and ad.user.whatsapp != ''}" 
                           th:href="${ad.user.whatsapp}" 
                           target="_blank" 
                           class="contact-btn whatsapp-btn">
                            <i class="bi bi-whatsapp"></i>
                            <span>WhatsApp</span>
                        </a>

                        <!-- Telegram -->
                        <a th:if="${ad.user.telegram != null and ad.user.telegram != ''}" 
                           th:href="${ad.user.telegram}" 
                           target="_blank" 
                           class="contact-btn telegram-btn">
                            <i class="bi bi-telegram"></i>
                            <span>Telegram</span>
                        </a>

                        <!-- Favorite Button -->
                        <button id="favoriteBtn" 
                                class="contact-btn favorite-btn" 
                                th:data-ad-id="${ad.id}"
                                onclick="toggleFavorite(this)">
                            <i id="favoriteIcon" class="bi bi-heart"></i>
                            <span id="favoriteText">Favorite</span>
                        </button>
                    </div>

                    <!-- Social Media -->
                    <div class="social-media-compact" th:if="${ad.user.linkdin != null or ad.user.facebook != null or ad.user.instagram != null}">
                        <span class="social-label">Follow:</span>
                        <div class="social-icons-compact">
                            <a th:if="${ad.user.linkdin != null and ad.user.linkdin != ''}" 
                               th:href="${ad.user.linkdin}" target="_blank" class="social-icon-compact linkedin">
                                <i class="bi bi-linkedin"></i>
                            </a>
                            <a th:if="${ad.user.facebook != null and ad.user.facebook != ''}" 
                               th:href="${ad.user.facebook}" target="_blank" class="social-icon-compact facebook">
                                <i class="bi bi-facebook"></i>
                            </a>
                            <a th:if="${ad.user.instagram != null and ad.user.instagram != ''}" 
                               th:href="${ad.user.instagram}" target="_blank" class="social-icon-compact instagram">
                                <i class="bi bi-instagram"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal for Zoom -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                            data-bs-dismiss="modal" aria-label="Close" style="z-index: 1060;"></button>
                    <img id="modalImage" src="" class="img-fluid w-100 rounded" alt="Full size image">
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">
                        <i class="bi bi-chat-dots me-2"></i>
                        Send Message
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="senderName" class="form-label">Your Name</label>
                            <input type="text" class="form-control" id="senderName" required>
                        </div>
                        <div class="mb-3">
                            <label for="senderEmail" class="form-label">Your Email</label>
                            <input type="email" class="form-control" id="senderEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="messageText" class="form-label">Message</label>
                            <textarea class="form-control" id="messageText" rows="4" required
                                      th:placeholder="'I am interested in your ad: ' + ${ad.title}"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">
                        <i class="bi bi-send me-2"></i>
                        Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Image Gallery Functions
        function changeMainImage(imageSrc, index) {
            document.getElementById('mainImage').src = imageSrc;
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail-image').forEach(img => img.classList.remove('active'));
            document.querySelectorAll('.thumbnail-image')[index].classList.add('active');
        }

        function scrollThumbnails(direction) {
            const track = document.getElementById('thumbnailTrack');
            const scrollAmount = 120; // Width of thumbnail + gap
            
            if (direction === 'next') {
                track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
            } else {
                track.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
            }
        }

        // Image Modal
        function openImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        // Compact Phone Display
        function showPhoneCompact(button) {
            const phone = button.getAttribute('data-phone');
            button.innerHTML = `<i class="bi bi-telephone"></i><span>${phone}</span>`;
            button.classList.add('phone-revealed');
        }

        // Send Email Function
        function sendEmail(button) {
            const email = button.getAttribute('data-email');
            const subject = encodeURIComponent('Inquiry about: ' + /*[[${ad.title}]]*/ 'Ad');
            const body = encodeURIComponent('Hi,\n\nI am interested in your ad "' + /*[[${ad.title}]]*/ 'Ad' + '".\n\nPlease contact me for more details.\n\nBest regards');
            window.location.href = 'mailto:' + email + '?subject=' + subject + '&body=' + body;
        }

        // Keyboard Navigation for Image Gallery
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('imageModal').classList.contains('show')) {
                if (e.key === 'ArrowLeft') {
                    // Navigate to previous image
                } else if (e.key === 'ArrowRight') {
                    // Navigate to next image
                } else if (e.key === 'Escape') {
                    bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
                }
            }
        });

        // Increase view count
        document.addEventListener('DOMContentLoaded', function() {
            const adId = /*[[${ad.id}]]*/ 0;
            
            fetch('/api/ads/' + adId + '/view', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).catch(error => {
                console.log('Error updating view count:', error);
            });
            
            // Check favorite status when page loads
            checkFavoriteStatus();
        });

        // Toggle favorite function
        function toggleFavorite(button) {
            const adId = button.getAttribute('data-ad-id');
            const favoriteIcon = document.getElementById('favoriteIcon');
            const favoriteText = document.getElementById('favoriteText');
            
            // Add loading state
            button.classList.add('loading');
            button.disabled = true;
            
            fetch('/api/favorites/toggle/' + adId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                button.classList.remove('loading');
                button.disabled = false;
                
                if (data.success) {
                    if (data.requireLogin) {
                        // Redirect to login page
                        window.location.href = '/auth/login';
                        return;
                    }
                    
                    // Update button based on action
                    if (data.action === 'added') {
                        button.classList.add('favorited');
                        favoriteIcon.className = 'bi bi-heart-fill';
                        favoriteText.textContent = 'Favorited';
                    } else if (data.action === 'removed') {
                        button.classList.remove('favorited');
                        favoriteIcon.className = 'bi bi-heart';
                        favoriteText.textContent = 'Favorite';
                    }
                    
                    // Show success message briefly
                    showToastCompact(data.message, 'success');
                } else {
                    // Show error message
                    showToastCompact(data.message || 'An error occurred', 'error');
                }
            })
            .catch(error => {
                // Remove loading state
                button.classList.remove('loading');
                button.disabled = false;
                
                console.error('Error:', error);
                showToastCompact('An error occurred. Please try again.', 'error');
            });
        }
        
        // Check favorite status function
        function checkFavoriteStatus() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            const favoriteIcon = document.getElementById('favoriteIcon');
            const favoriteText = document.getElementById('favoriteText');
            const adId = favoriteBtn.getAttribute('data-ad-id');
            
            fetch('/api/favorites/check/' + adId)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.isLoggedIn) {
                    if (data.isFavorite) {
                        favoriteBtn.classList.add('favorited');
                        favoriteIcon.className = 'bi bi-heart-fill';
                        favoriteText.textContent = 'Favorited';
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        favoriteIcon.className = 'bi bi-heart';
                        favoriteText.textContent = 'Favorite';
                    }
                }
            })
            .catch(error => {
                console.log('Error checking favorite status:', error);
            });
        }
        
        // Simple toast notification function for compact view
        function showToastCompact(message, type) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.minWidth = '250px';
            toast.style.fontSize = '0.9rem';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
    </script>
</body>
</html>
