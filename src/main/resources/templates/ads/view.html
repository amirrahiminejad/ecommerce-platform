<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${ad.title} + ' - Iran ECommerce'">Ad Details - Iran ECommerce</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Universal Styles -->
    <link href="/css/universal-styles.css" rel="stylesheet">
    <link href="/css/ads-view-styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/images/logo-persia-bazaar-small.png" alt="Iran ECommerce" height="100">
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white" href="/">
                    <i class="bi bi-house me-1"></i>
                    Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item">
                    <a href="/" class="text-decoration-none">Home</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="/" class="text-decoration-none">Ads</a>
                </li>
                <li class="breadcrumb-item" th:if="${ad.category}">
                    <a href="#" class="text-decoration-none" th:text="${ad.category.name}">Category</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${ad.title}">Ad Title</li>
            </ol>
        </nav>


        <div class="row">
            <!-- Ad Details -->
            <div class="col-lg-8">
                <div class="ad-detail-card">
                    <!-- Image Slider -->
                    <div class="image-slider">
                        <div th:if="${ad.images != null and #lists.size(ad.images) > 0}" 
                             id="adImageCarousel" class="carousel slide" data-bs-ride="carousel">
                            
                            <!-- Indicators -->
                            <div class="carousel-indicators">
                                <button th:each="adImage, iterStat : ${ad.images}" 
                                        type="button" 
                                        data-bs-target="#adImageCarousel" 
                                        th:data-bs-slide-to="${iterStat.index}"
                                        th:class="${iterStat.index == 0} ? 'active' : ''"
                                        th:aria-current="${iterStat.index == 0} ? 'true' : 'false'"
                                        th:aria-label="'Slide ' + ${iterStat.index + 1}">
                                </button>
                            </div>
                            
                            <!-- Slides -->
                            <div class="carousel-inner">
                                <div th:each="adImage, iterStat : ${ad.images}" 
                                     th:class="${iterStat.index == 0} ? 'carousel-item active' : 'carousel-item'">
                                    <img th:src="@{'/uploads/' + ${adImage.image.filename}}" 
                                         class="d-block w-100" 
                                         th:alt="${ad.title}">
                                </div>
                            </div>
                            
                            <!-- Controls -->
                            <button class="carousel-control-prev" type="button" data-bs-target="#adImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#adImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        
                        <!-- No Image Placeholder -->
                        <div th:unless="${ad.images != null and #lists.size(ad.images) > 0}" 
                             class="no-image-placeholder">
                            <i class="bi bi-image"></i>
                        </div>
                    </div>
                    
                    <!-- Ad Content -->
                    <div class="ad-content">
                        <h1 class="ad-title" th:text="${ad.title}">Ad Title</h1>
                        
                        <div class="d-flex align-items-center mb-3">
                            <div class="ad-price" th:text="${#numbers.formatDecimal(ad.price, 0, 'COMMA', 0, 'POINT')} + ' $'">
                                Price
                            </div>
                            <span th:if="${ad.negotiable}" class="negotiable-badge">
                                Negotiable
                            </span>
                        </div>
                        

                        
                        <!-- Description -->
                        <div th:if="${ad.description}">
                            <h3>
                                <i class="bi bi-text-paragraph me-2"></i>
                                Description
                            </h3>
                            <div class="ad-description" th:text="${ad.description}">
                                Ad description will be displayed here
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- User Info -->
                <div class="user-info-card">
                    <div class="text-center">
                        <div class="user-avatar mx-auto" th:text="${#strings.substring(ad.user.firstName, 0, 1) + #strings.substring(ad.user.lastName, 0, 1)}">
                            ...
                        </div>
                        <div class="user-name" th:text="${ad.user.firstName + ' ' + ad.user.lastName}">
                            User Name
                        </div>
                        <div class="user-join-date" th:text="'Member since ' + ${#temporals.format(ad.user.createdAt, 'MMMM yyyy')}">
                            Member since
                        </div>
                    </div>
                    
                    <div class="contact-buttons">
                        <button class="btn btn-contact" data-bs-toggle="modal" data-bs-target="#contactModal">
                            <i class="bi bi-chat-dots me-2"></i>
                            Send Message
                        </button>
                        
                        <button th:if="${ad.user.phoneNumber}" 
                                class="btn btn-phone" 
                                onclick="showPhoneNumber(this)"
                                th:data-phone="${ad.user.phoneNumber}">
                            <i class="bi bi-telephone me-2"></i>
                            Show Phone Number
                        </button>
                        
                        <!-- Email Button -->
                        <button th:if="${ad.user.email}" 
                                class="btn btn-email" 
                                onclick="sendEmail(this)"
                                th:data-email="${ad.user.email}">
                            <i class="bi bi-envelope me-2"></i>
                            Send Email
                        </button>
                        
                        <!-- Favorite Button -->
                        <button id="favoriteBtn" 
                                class="btn btn-favorite" 
                                th:data-ad-id="${ad.id}"
                                onclick="toggleFavorite(this)">
                            <i id="favoriteIcon" class="bi bi-heart me-2"></i>
                            <span id="favoriteText">Add to Favorites</span>
                        </button>
                    </div>
                    
                    <!-- Social Media Links -->
                    <div class="social-media-section" th:if="${ad.user.linkdin != null or ad.user.facebook != null or ad.user.instagram != null or ad.user.whatsapp != null or ad.user.telegram != null}">
                        <div class="section-title">
                            <i class="bi bi-share me-2"></i>
                            Follow on Social Media
                        </div>
                        <div class="social-links">
                            <a th:if="${ad.user.linkdin != null and ad.user.linkdin != ''}" 
                               th:href="${ad.user.linkdin}" 
                               target="_blank" 
                               class="social-link linkedin"
                               title="LinkedIn Profile">
                                <i class="bi bi-linkedin"></i>
                                <span>LinkedIn</span>
                            </a>
                            <a th:if="${ad.user.facebook != null and ad.user.facebook != ''}" 
                               th:href="${ad.user.facebook}" 
                               target="_blank" 
                               class="social-link facebook"
                               title="Facebook Profile">
                                <i class="bi bi-facebook"></i>
                                <span>Facebook</span>
                            </a>
                            <a th:if="${ad.user.instagram != null and ad.user.instagram != ''}" 
                               th:href="${ad.user.instagram}" 
                               target="_blank" 
                               class="social-link instagram"
                               title="Instagram Profile">
                                <i class="bi bi-instagram"></i>
                                <span>Instagram</span>
                            </a>
                            <a th:if="${ad.user.whatsapp != null and ad.user.whatsapp != ''}" 
                               th:href="${ad.user.whatsapp}" 
                               target="_blank" 
                               class="social-link whatsapp"
                               title="WhatsApp Chat">
                                <i class="bi bi-whatsapp"></i>
                                <span>WhatsApp</span>
                            </a>
                            <a th:if="${ad.user.telegram != null and ad.user.telegram != ''}" 
                               th:href="${ad.user.telegram}" 
                               target="_blank" 
                               class="social-link telegram"
                               title="Telegram Chat">
                                <i class="bi bi-telegram"></i>
                                <span>Telegram</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="contact-info-section">
                        <div class="section-title">
                            <i class="bi bi-person-lines-fill me-2"></i>
                            Contact Information
                        </div>
                        <div class="contact-info">
                            <div class="contact-item" th:if="${ad.user.email}">
                                <i class="bi bi-envelope-fill"></i>
                                <span class="contact-label">Email:</span>
                                <span class="contact-value" th:text="${ad.user.email}">email@example.com</span>
                            </div>
                            <div class="contact-item" th:if="${ad.user.phoneNumber}">
                                <i class="bi bi-telephone-fill"></i>
                                <span class="contact-label">Phone:</span>
                                <span class="contact-value phone-hidden" th:data-phone="${ad.user.phoneNumber}">
                                    Click to show
                                </span>
                            </div>
                            <div class="contact-item">
                                <i class="bi bi-calendar-fill"></i>
                                <span class="contact-label">Member since:</span>
                                <span class="contact-value" th:text="${#temporals.format(ad.user.createdAt, 'MMMM yyyy')}">
                                    Date
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="user-info-card">
                    <!-- Meta Information -->
                    <div class="ad-meta">
                        <div class="meta-item">
                                <span class="meta-label">
                                    <i class="bi bi-calendar3 me-2"></i>
                                    Published Date
                                </span>
                            <span class="meta-value" th:text="${#temporals.format(ad.createdAt, 'yyyy/MM/dd')}">
                                    Date
                                </span>
                        </div>

                        <div class="meta-item" th:if="${ad.category}">
                                <span class="meta-label">
                                    <i class="bi bi-tag me-2"></i>
                                    Category
                                </span>
                            <span class="meta-value" th:text="${ad.category.name}">
                                    Category
                                </span>
                        </div>

                        <div class="meta-item" th:if="${ad.location}">
                                <span class="meta-label">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    Location
                                </span>
                            <!--                                <span class="meta-value" th:text="${ad.location.city + ', ' + ad.location.province}">-->
                            <span class="meta-value" th:text="${ad.location.city}">
                                    City, Province
                                </span>
                        </div>

<!--                        <div class="meta-item">-->
<!--                                <span class="meta-label">-->
<!--                                    <i class="bi bi-eye me-2"></i>-->
<!--                                    Views-->
<!--                                </span>-->
<!--                            <span class="meta-value" th:text="${ad.viewsCount}">-->
<!--                                    0-->
<!--                                </span>-->
<!--                        </div>-->

                        <div class="meta-item">
                                <span class="meta-label">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Status
                                </span>
                            <span class="meta-value">
                                    <span th:switch="${ad.status.name()}" class="status-badge">
                                        <span th:case="'APPROVED'" class="status-approved">APPROVED</span>
                                        <span th:case="'PENDING'" class="status-pending">PENDING</span>
                                        <span th:case="'REJECTED'" class="status-rejected">REJECTED</span>
                                    </span>
                                </span>
                        </div>
                    </div>
                </div>
<!--                    todo: Similar Ads-->
<!--                &lt;!&ndash; Similar Ads &ndash;&gt;-->
<!--                <div class="similar-ads" th:if="${similarAds != null and #lists.size(similarAds) > 0}">-->
<!--                    <h4 class="mb-3">-->
<!--                        <i class="bi bi-collection me-2"></i>-->
<!--                        Similar Ads-->
<!--                    </h4>-->
<!--                    -->
<!--                    <div th:each="similarAd : ${similarAds}" class="similar-ad-item">-->
<!--                        <a th:href="@{'/ads/' + ${similarAd.id}}" class="similar-ad-title text-decoration-none">-->
<!--                            <span th:text="${similarAd.title}">Similar Ad Title</span>-->
<!--                        </a>-->
<!--                        <div class="similar-ad-price mt-1" th:text="${#numbers.formatDecimal(similarAd.price, 0, 'COMMA', 0, 'POINT')} + '$'">-->
<!--                            Price-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
            </div>
        </div>
        
        <!-- Back Button -->
        <div class="text-center mt-4">
            <button class="back-button" onclick="history.back()">Back</button>

        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">Send Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contactForm" method="post" th:action="@{/messages/send}">
                        <!-- Hidden field for ad ID -->
                        <input type="hidden" name="adId" th:value="${ad.id}">
                        
                        <!-- Show name/email fields only for non-authenticated users -->
                        <div th:unless="${isAuthenticated}">
                            <div class="mb-3">
                                <label for="senderName" class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="senderName" name="senderName" required>
                            </div>
                            <div class="mb-3">
                                <label for="senderEmail" class="form-label">Your Email</label>
                                <input type="email" class="form-control" id="senderEmail" name="senderEmail" required>
                            </div>
                        </div>
                        
                        <!-- Message content -->
                        <div class="mb-3">
                            <label for="content" class="form-label">Message</label>
                            <textarea class="form-control" id="content" name="content" rows="4" 
                                      minlength="10" maxlength="1000" 
                                      placeholder="Enter your message (10-1000 characters)" required></textarea>
                            <div class="form-text">
                                <span id="charCount">0</span>/1000 characters
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-universal btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="contactForm" class="btn-universal btn-primary">Send Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Show phone number
        function showPhoneNumber(button) {
            const phone = button.getAttribute('data-phone');
            button.innerHTML = '<i class="bi bi-telephone me-2"></i>' + phone;
            button.onclick = function() {
                window.location.href = 'tel:' + phone;
            };
        }
        
        // Send email function
        function sendEmail(button) {
            const email = button.getAttribute('data-email');
            const subject = encodeURIComponent('Inquiry about: ' + /*[[${ad.title}]]*/ 'Ad');
            const body = encodeURIComponent('Hi,\n\nI am interested in your ad "' + /*[[${ad.title}]]*/ 'Ad' + '".\n\nPlease contact me for more details.\n\nBest regards');
            window.location.href = 'mailto:' + email + '?subject=' + subject + '&body=' + body;
        }
        
        // Show phone number in contact info
        function showContactPhone(element) {
            const phone = element.getAttribute('data-phone');
            if (phone) {
                element.textContent = phone;
                element.classList.remove('phone-hidden');
                element.classList.add('phone-revealed');
                element.onclick = function() {
                    window.location.href = 'tel:' + phone;
                };
                element.style.cursor = 'pointer';
                element.title = 'Click to call';
            }
        }
        
        // Character counter for message content
        document.addEventListener('DOMContentLoaded', function() {
            const contentTextarea = document.getElementById('content');
            const charCount = document.getElementById('charCount');
            
            if (contentTextarea && charCount) {
                contentTextarea.addEventListener('input', function() {
                    const currentLength = this.value.length;
                    charCount.textContent = currentLength;
                    
                    // Change color based on length
                    if (currentLength < 10) {
                        charCount.style.color = '#dc3545'; // red
                    } else if (currentLength > 900) {
                        charCount.style.color = '#fd7e14'; // orange
                    } else {
                        charCount.style.color = '#6c757d'; // gray
                    }
                });
            }
            
            // Initialize phone number click handlers
            const phoneElements = document.querySelectorAll('.phone-hidden');
            phoneElements.forEach(element => {
                element.addEventListener('click', function() {
                    showContactPhone(this);
                });
                element.style.cursor = 'pointer';
                element.title = 'Click to show phone number';
            });
        });
        
        // Increase view count
        document.addEventListener('DOMContentLoaded', function() {
            // AJAX request to increase view count
            const adId = /*[[${ad.id}]]*/ 0;
            
            fetch('/api/ads/' + adId + '/view', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).catch(error => {
                console.log('Error updating view count:', error);
            });
            
            // Check favorite status when page loads
            checkFavoriteStatus();
        });
        
        // Toggle favorite function
        function toggleFavorite(button) {
            const adId = button.getAttribute('data-ad-id');
            const favoriteIcon = document.getElementById('favoriteIcon');
            const favoriteText = document.getElementById('favoriteText');
            
            // Add loading state
            button.classList.add('loading');
            button.disabled = true;
            
            fetch('/api/favorites/toggle/' + adId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                button.classList.remove('loading');
                button.disabled = false;
                
                if (data.success) {
                    if (data.requireLogin) {
                        // Redirect to login page
                        window.location.href = '/auth/login';
                        return;
                    }
                    
                    // Update button based on action
                    if (data.action === 'added') {
                        button.classList.add('favorited');
                        favoriteIcon.className = 'bi bi-heart-fill me-2';
                        favoriteText.textContent = 'Remove from Favorites';
                    } else if (data.action === 'removed') {
                        button.classList.remove('favorited');
                        favoriteIcon.className = 'bi bi-heart me-2';
                        favoriteText.textContent = 'Add to Favorites';
                    }
                    
                    // Show success message briefly
                    showToast(data.message, 'success');
                } else {
                    // Show error message
                    showToast(data.message || 'An error occurred', 'error');
                }
            })
            .catch(error => {
                // Remove loading state
                button.classList.remove('loading');
                button.disabled = false;
                
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            });
        }
        
        // Check favorite status function
        function checkFavoriteStatus() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            const favoriteIcon = document.getElementById('favoriteIcon');
            const favoriteText = document.getElementById('favoriteText');
            const adId = favoriteBtn.getAttribute('data-ad-id');
            
            fetch('/api/favorites/check/' + adId)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.isLoggedIn) {
                    if (data.isFavorite) {
                        favoriteBtn.classList.add('favorited');
                        favoriteIcon.className = 'bi bi-heart-fill me-2';
                        favoriteText.textContent = 'Remove from Favorites';
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        favoriteIcon.className = 'bi bi-heart me-2';
                        favoriteText.textContent = 'Add to Favorites';
                    }
                }
            })
            .catch(error => {
                console.log('Error checking favorite status:', error);
            });
        }
        
        // Simple toast notification function
        function showToast(message, type) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to page
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
    </script>
</body>
</html>
