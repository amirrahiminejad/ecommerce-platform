<!DOCTYPE html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isEdit != null && isEdit ? 'Edit Ad - Iran ECommerce' : 'Post New Ad - Iran ECommerce'}">Post New Ad - Iran ECommerce</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Universal Styles -->
    <link href="/css/universal-styles.css" rel="stylesheet">
    <link href="/css/ads-create-styles.css" rel="stylesheet">
</head>
<body class="ads-page">
    <div class="container my-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-custom">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
                <li class="breadcrumb-item"><a href="/profile" class="text-decoration-none">My Profile</a></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${isEdit != null && isEdit ? 'Edit Ad' : 'Post New Ad'}">Post New Ad</li>
            </ol>
        </nav>

        <!-- Success/Error Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-custom">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${successMessage}">Success message</span>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger alert-custom">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${errorMessage}">Error message</span>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">
                        <i class="bi" th:class="${isEdit != null && isEdit ? 'bi bi-pencil-square me-2' : 'bi bi-plus-circle me-2'}"></i>
                        <span th:text="${isEdit != null && isEdit ? 'Edit Ad' : 'Post New Ad'}">Post New Ad</span>
                    </h2>
                    <p class="mb-0 opacity-75">
                        Post your ad in a few simple steps
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/profile" class="btn btn-light btn-custom">
                        <i class="bi bi-arrow-left me-2"></i>
                        Back to Profile
                    </a>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="form-card">

                    <form th:action="${isEdit != null && isEdit ? '/ads/edit/' + adId : '/ads/create'}" th:object="${ad}" method="post" enctype="multipart/form-data" id="adForm">

                        <!-- Basic Information Section -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-info-circle"></i>
                                Basic Information
                            </h5>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" th:field="*{title}" id="title" class="form-control" placeholder="Ad Title" required>
                                        <label for="title">Ad Title</label>
                                        <div th:if="${#fields.hasErrors('title')}" class="invalid-feedback d-block" th:errors="*{title}"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <select th:field="*{categoryId}" id="category" class="form-select" required>
                                            <option value="">Select Category</option>
                                            <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                                        </select>
                                        <label for="category">Category</label>
                                        <div th:if="${#fields.hasErrors('categoryId')}" class="invalid-feedback d-block" th:errors="*{categoryId}"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3 position-relative">
<!--                                        <span class="price-currency">$</span>-->
                                        <input type="number" th:field="*{price}" id="price" class="form-control price-input" placeholder="Price" min="0">
                                        <label for="price">Price</label>
                                        <div th:if="${#fields.hasErrors('price')}" class="invalid-feedback d-block" th:errors="*{price}"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <select th:field="*{locationId}" id="location" class="form-select">
                                            <option value="">Select Location</option>
                                            <option th:each="location : ${locations}" th:value="${location.id}" th:text="${location.city}"></option>
                                        </select>
                                        <label for="location">Location</label>
                                        <div th:if="${#fields.hasErrors('locationId')}" class="invalid-feedback d-block" th:errors="*{locationId}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description Section -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-list-task"></i>
                                Description
                            </h5>

                            <div class="form-floating mb-3">
                                <textarea th:field="*{description}" id="description" class="form-control" placeholder="Description" style="height: 150px" required></textarea>
                                <label for="description">Description</label>
                                <div th:if="${#fields.hasErrors('description')}" class="invalid-feedback d-block" th:errors="*{description}"></div>
                            </div>

                            <div class="form-check">
                                <input th:field="*{negotiable}" class="form-check-input" type="checkbox" id="negotiable">
                                <label class="form-check-label" for="negotiable">
                                    Negotiable
                                </label>
                            </div>
                        </div>

                        <!-- Images Section -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-images"></i>
                                Images
                            </h5>

                            <!-- Existing Images (only in edit mode) -->
                            <div th:if="${isEdit != null && isEdit && existingImages != null && !existingImages.isEmpty()}" class="existing-images mb-3">
                                <h6 class="text-muted mb-2">Current Images:</h6>
                                <div class="row">
                                    <div class="col-md-3 mb-2" th:each="image : ${existingImages}">
                                        <div class="existing-image-item position-relative">
                                            <img th:src="${image.url}" th:alt="${image.originalFilename}" 
                                                 class="img-thumbnail w-100" style="height: 120px; object-fit: cover;">
                                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" 
                                                    th:onclick="'removeExistingImage(' + ${image.id} + ')'"
                                                    style="transform: translate(50%, -50%);">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            <input type="hidden" th:name="'keepImages'" th:value="${image.id}" class="keep-image-input">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="image-upload-area" onclick="document.getElementById('images').click()">
                                <i class="bi bi-cloud-upload upload-icon"></i>
                                <h6>Click or drag images here</h6>
                                <p class="mb-0">Maximum 10 images | Each image max 5MB</p>
                                <input type="file" id="images" name="images" multiple accept="image/*" style="display: none;">
                            </div>

                            <div id="imagePreview" class="row mt-3"></div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between pt-4 mt-4 border-top">

                            <button class="back-button" onclick="history.back()">
                                Back
                            </button>

                            <button type="submit" class="btn-universal btn-primary">
                                <i class="bi bi-check-lg"></i>
                                <span th:text="${isEdit != null && isEdit ? 'Update Ad' : 'Post Ad'}">Post Ad</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Image upload functionality
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('images');
            const imagePreview = document.getElementById('imagePreview');
            const uploadArea = document.querySelector('.image-upload-area');
            let selectedImages = [];

            // Handle file selection
            imageInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.background = '#e7f3ff';
                uploadArea.style.borderColor = '#667eea';
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.background = '#f8f9fa';
                uploadArea.style.borderColor = '#dee2e6';
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.background = '#f8f9fa';
                uploadArea.style.borderColor = '#dee2e6';
                handleFiles(e.dataTransfer.files);
            });

            function handleFiles(files) {
                for (let file of files) {
                    if (file.type.startsWith('image/') && selectedImages.length < 10) {
                        selectedImages.push(file);
                        displayImage(file);
                    }
                }
                updateFileInput();
            }

            function displayImage(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'col-md-3 mb-3';
                    imageDiv.innerHTML = `
                        <div class="position-relative">
                            <img src="${e.target.result}" class="img-fluid rounded" style="height: 150px; object-fit: cover; width: 100%;">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" onclick="removeImage(this, '${file.name}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    `;
                    imagePreview.appendChild(imageDiv);
                };
                reader.readAsDataURL(file);
            }

            function updateFileInput() {
                const dt = new DataTransfer();
                selectedImages.forEach(file => dt.items.add(file));
                imageInput.files = dt.files;
            }

            // Make removeImage function global
            window.removeImage = function(button, fileName) {
                selectedImages = selectedImages.filter(file => file.name !== fileName);
                button.closest('.col-md-3').remove();
                updateFileInput();
            };

            // Function to remove existing images
            window.removeExistingImage = function(imageId) {
                const imageContainer = document.querySelector(`button[onclick*="${imageId}"]`).closest('.col-md-3');
                const keepInput = imageContainer.querySelector('.keep-image-input');
                
                // Remove the hidden input so the image won't be kept
                if (keepInput) {
                    keepInput.remove();
                }
                
                // Hide the image container
                imageContainer.style.display = 'none';
            };
        });
            const tabButtons = document.querySelectorAll('.nav-link');

            if (n >= totalTabs) n = totalTabs - 1;
            if (n < 0) n = 0;

            // Hide all tabs
            tabs.forEach(tab => {
                tab.classList.remove('show', 'active');
            });

            // Remove active class from all tab buttons
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });


            // Form validation
            document.getElementById('adForm').addEventListener('submit', function(e) {
                const requiredFields = document.querySelectorAll('[required]');
                let isValid = true;

                for (let field of requiredFields) {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                }

                if (!isValid) {
                    e.preventDefault();
                    alert('Please fill in all required fields');
                }
            });
    </script>
</body>
</html>
